from fabric import task

from benchmark.logs import ParseError, LogParser
from benchmark.utils import Print
from benchmark.plot import Ploter, PlotError
from benchmark.local import LocalBench
from configurations.presets import remote_bench_parameters, remote_node_parameters, creation_nodes
from aws.instance import InstanceManager
from aws.remote import Bench, BenchError

@task
def local(ctx):
    ''' Run benchmarks on localhost '''
    bench_params = {
        'nodes': 4,
        'fast_brokers': 4,
        'full_brokers': 0,
        'full_clients': 0,
        'rate': 1_000_000,
        'duration': 300,
        'runs': 1,
    }

    node_params = {
        'broker': {
            'signup_batch_number': 10,
            'signup_batch_size': 5000,
            'prepare_batch_size': 50000,
            'prepare_batch_number': 5,
            'prepare_single_sign_percentage': 100,
            'brokerage_timeout': 1000, # millis
            'reduction_timeout': 1000, # millis
        },
    }
    try:
        ret = LocalBench(bench_params, node_params).run(debug=False).result()
        print(ret)
    except BenchError as e:
        Print.error(e)

@task
def local_logs(ctx):
    ''' Run benchmarks on localhost '''
    bench_params = {
        'nodes': 4,
        'fast_brokers': 4,
        'full_brokers': 0,
        'full_clients': 0,
        'rate': 1_000_000,
        'duration': 300,
        'runs': 1,
    }

    node_params = {
        'broker': {
            'signup_batch_number': 10,
            'signup_batch_size': 5000,
            'prepare_batch_size': 50000,
            'prepare_batch_number': 5,
            'prepare_single_sign_percentage': 100,
            'brokerage_timeout': 1000, # millis
            'reduction_timeout': 1000, # millis
        },
    }
    try:
        ret = LocalBench(bench_params, node_params).logs()
        print(ret)
    except BenchError as e:
        Print.error(e)  

@task
def create(ctx):
    ''' Create a testbed'''

    try:
        InstanceManager.make().create_instances(creation_nodes)
    except BenchError as e:
        Print.error(e)


@task
def destroy(ctx):
    ''' Destroy the testbed '''
    try:
        InstanceManager.make().terminate_instances()
    except BenchError as e:
        Print.error(e)


@task
def start(ctx, max = 8):
    ''' Start at most `max` machines per data center '''
    try:
        InstanceManager.make().start_instances(max)
    except BenchError as e:
        Print.error(e)


@task
def stop(ctx):
    ''' Stop all machines '''
    try:
        InstanceManager.make().stop_instances()
    except BenchError as e:
        Print.error(e)


@task
def info(ctx):
    ''' Display connect information about all the available machines '''
    try:
        InstanceManager.make().print_info()
    except BenchError as e:
        Print.error(e)


@task
def install(ctx):
    ''' Install the codebase on all machines '''
    try:
        Bench(ctx).install()
    except BenchError as e:
        Print.error(e)


@task
def remote(ctx):
    ''' Run benchmarks on AWS '''
    try:
        Bench(ctx).run(remote_bench_parameters, remote_node_parameters, debug=False)
    except BenchError as e:
        Print.error(e)


@task
def plot(ctx):
    ''' Plot performance using the logs generated by "fab remote" '''
    plot_params = {
        'nodes': [36],
        'brokers': [36],
        'rate': [36000000],
        'faults': [0],
    }
    try:
        Ploter.plot(plot_params)
    except PlotError as e:
        Print.error(BenchError('Failed to plot performance', e))


@task
def kill(ctx):
    ''' Stop any HotStuff execution on all machines '''
    try:
        Bench(ctx).kill()
    except BenchError as e:
        Print.error(e)


@task
def logs(ctx):
    ''' Print a summary of the logs '''
    try:
        Bench(ctx).dl_logs(remote_bench_params)
        print(LogParser.process('./logs').result())
    except ParseError as e:
        Print.error(BenchError('Failed to parse logs', e))

